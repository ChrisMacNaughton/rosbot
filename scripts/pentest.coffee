# Description
#   Script for scaning a target with Nmap
#
# Configuration:
#   ROCKETCHAT_BOTUSER
#   ROCKETCHAT_PASSWORD
#   ROCKETCHAT_AUTH
#   GITLAB_TOKEN
#   GITWEB
#   GITSERVER
#   NAMESPACE
#   ROCKETCHAT_API_URL
#
# Commands:
#   rosbot nmap help - Prints quick usage help
#   rosbot nmap <quick|full> <target_IP(s)> <project_name*> - Launches nmap scan against the given target. Pushes results to Gitlabs after sucessful run. Use 'nosave' as project name to bypass Gitlab (do scan only, return results to the RC).
#
# Notes:
#   Mew Mew Mew =^..^=
#
# Author:
#   Vytautas Paulikas
#   paulikas.vytautas@radicallyopensecurity.com


module.exports = (robot) ->
  run_cmd = (cmd, args, cb ) ->
    spawn = require("child_process").spawn
    child = spawn(cmd, args)
    child.stdout.on "data", (buffer) -> cb buffer.toString()
    child.stderr.on "data", (buffer) -> cb buffer.toString()

  robot.respond /nmap help/i, (msg) ->
   msg.send "Nmap scanning function usage:"
   msg.send "rosbot nmap <quick|full> <IP_or_Domain> <project-name>"
   msg.send "If project-name is not provided and the room where the command is issued is meant for a specific pentest (starts with pen-*), the project name will be extracted from the room's name."
   msg.send "Quick examples"
   msg.send "----"
   msg.send "rosbot nmap quick localhost"
   msg.send "rosbot nmap full 127.0.0.1/30 pen-sec-test"
   msg.send "rosbot nmap quick localhost nosave"
   msg.send "----"
   msg.send "P.S. By default the scan results WILL BE pushed to the coresponding repo in Gitlab! Use 'nosave' as the project name to perform scanning without pushing to Gitlab."

   
  robot.respond /nmap (quick|full) ([a-zA-Z0-9\.\-/]+)( )?([a-zA-Z0-9\-\_]+)?/i, (msg) ->
   scan_type = msg.match[1];
   target_host = msg.match[2];
   if (msg.match[3]==" ") and msg.match[4]
    target_client = msg.match[4];
   else
    target_client = msg.envelope.room;
   args = [scan_type, target_host, target_client];
   cmd = "python/handler_nmap.py";
   msg.send "Attempting to start Nmap scan for "+target_host+" ...";
   run_cmd cmd, args, (text) -> msg.send text;
